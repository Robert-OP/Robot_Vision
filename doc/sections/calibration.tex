\chapter{Camera calibration}\label{ch:calibration}

In order to achieve the goal, the robot arm needs to be combined with a camera which will provide important information to detect the correct position of the bricks. However, the use of this camera demanded a calibration which was done with a checkerboard. This calibration was essential in order to find the intrinsic and extrinsic parameters of the camera which were useful to make some transformations between frames. Besides, the calibration was also used to undistort images taken by the camera which were used to detect the position of the blocks.

The calibration of the camera was performed using the \textit{Camera Calibration Toolbox} and it was based on thirty different pictures of the checkerboard. In each image, four different corners were selected (the first corner was the origin) as well as defined the size of the each square. This process was repeated in the same order for all pictures to be able to calibrate the camera. After selecting all the corners, it was necessary to calibrate the camera using the data colected from the pictures. The first step of this calibration computes a closed-form solution for the calibration parameters without considering the lens distortion. This step is followed by a nonlinear optimization where the main goal is to minimize the total reprojection error over all the calibration parameters (intrinsic and extrinsic). This optimization is done iteratively based on the gradient descent method and, at the end, the result is a set of variables which describe every parameter. 

In addition, the calibration results also show the errors associated with some variables which allow to understand the quality of the calibration. Moreover, using the plot of the errors provided by the calibration, it becomes easy to compare the error between pictures and, based on this information, some pictures were eliminated (the ones with the biggest error values). After eliminating the worst pictures, the image corners were recomputed automatically using the function \textit{Recomp. Corners} and then the \textit{Calibration} function was applied in order to get new parameters with a small error.

Furthermore, the camera calibration was also used in the undistortion process to undistort the background image and the images with bricks. This process was essential to remove the deformation in the external areas and, thus, obtain the best position values of the blocks. \par

\vspace{10mm}
\noindent
\textbf{\Large{Intrinsic and Extrinsic Parameters}}
\vspace{5mm}

The parameters provided by the calibration of the camera can be used to make transformations between frames which is useful to calculate the correct position of the bricks. These parameters can be divided in two different groups: the intrinsic and the extrinsic. The intrinsic parameters are related to the camera (equation \ref{intrinsic}), for instances, the position of the principal point, the skew parameter (is zero because the axis are orthogonal) and the focal length. Using these parameters it is possible to combine the coordinates of the camera frame with the ones in the picture (pixels). The extrinsic parameters are the ones responsible for the relation between the world coordinates and the camera coordinates as is possible to see in \ref{extrinsic}.

\begin{align} 
\label{intrinsic}
\begin{bmatrix}
    \textit{u} \\ 
    \textit{v} \\
    \textit{w} 
\end{bmatrix}
=
\begin{bmatrix}
    \textit{f}  & 0 & p_{x} & 0\\
    0   &  \textit{f} & p_{y} & 0  \\
    0 & 0 & 1 & 0 
\end{bmatrix}
\begin{bmatrix}
   x_{s}\\
   y_{s}\\
   z_{s}\\
	1
\end{bmatrix}
\text{  , K}
=
\begin{bmatrix}
    \textit{f}  & 0 & p_{x} & 0\\
    0   &  \textit{f} & p_{y} & 0  \\
    0 & 0 & 1 & 0 
\end{bmatrix}
\end{align}

\begin{align} 
\label{extrinsic}
\begin{bmatrix}
   x_{s}\\
   y_{s}\\
   z_{s}\\
	1
\end{bmatrix}
=
\begin{bmatrix}
    \textit{R}  & \textit{T}
\end{bmatrix}
\begin{bmatrix}
   X_{w}\\
   Y_{w}\\
   Z_{w}\\
	1
\end{bmatrix}
\end{align}

Based on the relations between frames, it is possible to simplify the calculations associating the image coordinates with the world coordinates. The relation is made through a projective matrix ($3\times 4$ matrix) which is a result of the product between the intrinsic ($3\times 3$ matrix) and extrinsic ($3\times 4$ matrix) matrices.

\begin{align} 
\begin{bmatrix}
    \textit{u} \\ 
    \textit{v} \\
    \textit{w} 
\end{bmatrix}
=
\textit{K}
\begin{bmatrix}
    \textit{R}  & \textit{T}
\end{bmatrix}
\begin{bmatrix}
   X_{w}\\
   Y_{w}\\
   Z_{w}\\
	1
\end{bmatrix}
=
\textit{P}
\begin{bmatrix}
   X_{w}\\
   Y_{w}\\
   Z_{w}\\
	1
\end{bmatrix}
\end{align}

The projective matrix is a $3\times 4$ matrix which means that it is not invertible. However, it is possible to assume that \textit{Z} is always zero because the blocks are in the \textit{XY} plane and thus the third column of the projective matrix will be multiplied by zero. So, it is possible to ignore the third column of the projective matrix and the third row of the matrix with the world coordinates.

\begin{align} 
\begin{bmatrix}
    \textit{u} \\ 
    \textit{v} \\
    \textit{w} 
\end{bmatrix}
=
\textit{P}
\begin{bmatrix}
   X_{w}\\
   Y_{w}\\
	1
\end{bmatrix}
\end{align}

As a result, \textit{P} can be represented as $3\times 3$ matrix which means that it is invertible, as it is possible to observe in \ref{invertible}. 

\begin{align}
\begin{bmatrix}
   X_{w}\\
   Y_{w}\\
	1
\end{bmatrix} 
=
\textit{P}^{-1}
\begin{bmatrix}
    \textit{u} \\ 
    \textit{v} \\
    \textit{w} 
\end{bmatrix}
\label{invertible}
\end{align}

